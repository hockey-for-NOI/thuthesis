\chapter{引言}
\label{cha:intro}

CESM模型是一类应用较为广泛的自然气候变化模型，它包括大气模型，陆地模型，海洋模型等子模型。单个模型专注考虑某一个区域的物理过程，因此在与其他区域的接触面需要提供记录数据或联合其他模型互相提供数据才能尽可能模拟出真实过程。因此一套完整的模型运行流程由多个模型轮流运行互相提供数据组成。

耦合技术是一种专注于多个模型中数据交互的控制技术，其将每个模型封装成模式分量，然后由耦合器控制整体的运行时序、数据交互、存储恢复、统计分析等。其优点在于顶层耦合器封装了模式分量的运行细节，只将所需的数据暴露给分析部分，将底层实现与顶层分析尽可能隔离开来，从而能够平滑地替换不同模式分量，能够以较少的工作量进行不同模型组合的实验，或进行等位模式分量的对照实验。

由于耦合技术的重要性，国家重点研发计划大规模多模式多过程地球系统模式耦合平台研发项目提出了在架构上支持灵活快捷按需耦合的耦合描述方法研究子课题，现在已经设计并编写了一种可配置、基于代码生成的耦合代码生成框架，并已经通过了海气耦合实验验证。

在这一章里，我们将分别介绍CESM的主要框架、代码结构、运行方式，以及已有的基于代码生成的耦合代码生成框架的主要模块、集成功能、接口实现等信息。

\section{CESM}

CESM\texttrademark\footnote{http://www.cesm.ucar.edu/}，全称COMMUNITY EARTH SYSTEM MODEL，是由NCAR于1983年创建，作为供更广泛的气候研究界使用的免费全球大气模型。在过去的20年里，NCAR气候与全球动力学（CGD）部门为大学和NCAR科学家提供了一个全面的三维全球大气模型，用于分析和理解全球气候。由于其广泛使用，该模型被指定为社区工具，并被命名为社区气候模型（CCM）。经过20年的研究与发展，CCM的公式已经稳步改进，且运行该模型所需的计算机变得相对便宜且广泛可用，因而该模型在大学界和一些国家实验室中逐渐被广泛使用。

原始CCM模型的局限性在于它不包括全球海洋和海冰模型。因此，在1994年，NCAR科学家提交了一项计划，以国家科学基金会（NSF）开发和使用气候系统模型（CSM），其中包括大气、陆面、海洋和海冰的模型。这些模式分量能够对分量间的通量不进行任何的情况下进行耦合。该计划最初侧重于气候系统的物理方面，然后在随后的版本中追加了生物地球化学插件和高层大气模式分量。该项目的第一阶段是NCAR工作人员开发的模型，之后，模型和相关数据集将提供给科学界。此外，该项目还计划建立一个新的模型和代码社区，让感兴趣的科学界有机会参与CSM的各个方面。这也是我们能够基于该模型进行后续开发和封装的重要条件之一。

\subsection{主要框架}

CESM代码主要分为两部分：模式分量和实例生成脚本包。

模式分量主要分为大气模式分量atm\footnote {atmosphere}，海洋模式分量ocn\footnote {ocean}，陆地模式lnd\footnote {land}，海冰模式ice\footnote {sea-ice}，冰川模式glc\footnote {land-ice}，海浪模式wav\footnote {ocean-wave}，海河径流模式rof\footnote {river-runoff}，以及一个专门用于数据交换的模式分量drv\footnote {也作coupler, cpl}。

单个模式分量内部包含多种实现方式。不同实现方式通常含有不同意义，例如采用不同假设、运算核心公式不同、计算精度差异、网格划分和网格密度不同、物理意义不同等等。通常情况下每种模式分量选择且仅选择其中一种实现进行耦合运行。在特定的条件下（如在线比对同一模式分量的多种不同实现方式）可以在单个模式分量中应用多种实现方式同时进行耦合运算，但此种情况下数据处理会变得较通常时更为复杂。另外，如果某些模式分量对于整个实验来说影响很小或是并不关心，可以不采用实现或采用空实现。一般来说，一个以气候模拟为目的的耦合模型通常只采用每种模式的单一实现。

最常见的模式是纯数据模式分量，这种模式分量取 data 首字母 d 开头命名，作用是读取
测量数据用于与其他公式型模式分量进行数据交换，并接收其他模式分量传入的数据与真实数据进行对比做出数据统计
和误差分析。通常来说当单个模式分量要进行适配测试时，会将所有与之直接相连的模式分量设置为纯数据模式分量，
从而确保了待测试分量从其他分量获取的输入值较为准确，可以帮助进行针对待测试分量的耦合运行和数据分析。
而对于与待测分量不直接相连的分量，通常采用空实现以尽可能减少运行时间。另外，在某些综合耦合实验中，若某些
模式分量的实现与其他主要模式分量有较大差异，如实现未完成
(本文复现的 F2000 实验就是在海洋模式 pop2 未完成的情况下，用 docn 模式代替进行的实验)
，单个模式测试不满足要求，误差量级不符，联合测试不稳定或无法收敛等情况，可以采用纯数据模式分量代替其中不满足条件的分量进行耦合验证
(需要注意的是，此种情况下耦合模型误差较一个真实模式分量实现偏小，数据分析时应当考虑到这一点)
。

模式分量的主要实现方式取 community 首字母 c 命名，这种模型在CESM社区中广泛使用，经过各种工作人员和科学家的共同开发，以及大量实验验证和改进，通常被认为是该模式分量的 baseline 。实际上，当一个新的模式分量进行耦合测试时，其正确性由于纯数据模式分量的耦合测试来保证，而其实际精度通常根据由社区模型进行耦合而成的模型进行测算。这可以在一定程度上反映该模式分量实现对来自外部误差的敏感程度。另外，该社区模型也会不断采纳来自其他模型的公式进行修正，因而保证了其的即时性和准确度。目前大部分成型的实验都包含相当数量的社区模型作为其模式分量的实现。

另外还有残余模型和死亡模型。前者只有接口而没有具体内容，在耦合模式完全不需要也不读取某个模式分量的数据时使用，最大化运行效率。死亡模型则采用随机的公式进行计算，并将得出的随机结果传输给其他模型。这种模型无法得出有意义的数据和统计结论，通常只用于测试可行性和数据溢出错误处理，或配合其他模型测试运行速度。在实际的耦合实验中，残余模型经常被接入被忽略的部分，而死亡模型不会出现在实际耦合实验中。

驱动模式分量，也作耦合模式分量，是专门用于各个模式分量的数据交换的一个特殊的模式分量。在CESM代码中这个模块是作为一个模式分量来看待的
\footnote {而在我们的代码中，这个模块作为顶层耦合器被独立提出并进行改进以增加适用性}
。
在任何实验中，驱动模式分量必须存在，且每个模式分量都只和驱动模式分量进行通信。因而所有的通信方式都被硬编码为“向驱动模式分量发送数据”和“从驱动模式分量获取数据”。实际上，驱动模式分量也有不同的实现方式
(常见的包括 cpl\_mct ， cpl\_esmf 等)
，而对于每种驱动方式，由于数据传输被硬编码在每个模式分量中，因此每个模式分量的每一个实现都必须对驱动模式分量的每一个实现进行分别硬编码(这应该是CESM最严重的缺点之一，也是我们主要要解决的问题)。

实例生成脚本包是一套用于在不同平台上自动或半自动配置各种已完成实验来进行复现的一套工具。一个新的实验完成后也会被添加到这个脚本包中，同时该模型的简要构成和各个模式分量的实现会被放到CESM官网的
支持分量集合
(http://www.cesm.ucar.edu/models/cesm1.2/cesm/doc/modelnl/compsets.html)
中。
复现一个已知实验时，如果在CESM预设设备群中\footnote{大部分预设设备配置了固定的绝对路径以找到对应的输入文件，表格文件等配置，在自用设备中需要自己单独配置}，在这个表格内找到待复现的实验的短代码，并将其与设备名称一同输入到 cesm\_setup 脚本中，即可完成全自动配置。

实际复现中，由于我们运行的实验平台并不属于预设平台，需要自行修改配置文件以运行和复现。此种情况下，需要将配置脚本进行拆分，自行下载输入数据和安装依赖包，并把对应的输入文件和表格文件放到其硬编码的路径下以实现半自动配置(实际上，在我们重构的耦合平台中，这一步骤被改进为自适应地构建，可以根据数据包路径结构自行调整)。具体来说， cesm\_setup 脚本读取预设配置文件，将所有依赖库分发到各个模式分量的实现中并分别编译，并将输入文件和表格文件的硬编码路径写入每个模式分量实现目录下的 namelist 文件作为运行时配置。我们可以修改 cesm\_setup 脚本的硬编码路径，也可以选择分别手工编译每个模式分量实现后修改生成的 namelist 文件以达到同样的效果。
